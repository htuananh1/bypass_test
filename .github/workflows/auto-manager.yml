name: Auto Codespace Manager

on:
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'

jobs:
  backup-and-monitor:
    runs-on: ubuntu-latest
    env:
      VERCEL_BACKUP_URL: ${{ secrets.VERCEL_BACKUP_URL }}
      VERCEL_STATUS_URL: ${{ secrets.VERCEL_STATUS_URL }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Call status endpoint
        if: env.VERCEL_STATUS_URL != ''
        run: |
          curl -fsSL -X GET "$VERCEL_STATUS_URL" || echo "status endpoint failed"

      - name: Trigger backup endpoint
        if: env.VERCEL_BACKUP_URL != ''
        run: |
          curl -fsSL -X POST "$VERCEL_BACKUP_URL" -H "Authorization: Bearer $GITHUB_TOKEN" || echo "backup endpoint failed"

      - name: Log heartbeat issue
        if: github.event_name == 'workflow_dispatch'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          gh issue create --title "Manual auto-manager run $ts" --body "Triggered backup/status workflow at $ts" --label automation || true
